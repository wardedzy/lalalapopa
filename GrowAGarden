-- ╔═══════════════════════════════════════════════════════════════╗
-- ║                 JOMHUB SAFE VERSION V1.0                      ║
-- ║              SAFE AUTO FARM + QUEST SYSTEM                    ║
-- ║                  ANTI-DETECTION BUILD                         ║
-- ╚═══════════════════════════════════════════════════════════════╝

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
if not player then return end

-- Theme Colors
local THEME = {
    Background = Color3.fromRGB(30, 40, 60),
    BackgroundDark = Color3.fromRGB(20, 25, 40),
    Sidebar = Color3.fromRGB(15, 20, 35),
    SectionBg = Color3.fromRGB(25, 30, 50),
    Accent = Color3.fromRGB(100, 150, 255),
    Blue = Color3.fromRGB(80, 140, 255),
    Green = Color3.fromRGB(50, 205, 50),
    Text = Color3.fromRGB(220, 230, 255),
    TextDim = Color3.fromRGB(180, 190, 220),
    GradientStart = Color3.fromRGB(40, 60, 100),
    GradientEnd = Color3.fromRGB(80, 50, 120),
    ToggleOn = Color3.fromRGB(100, 255, 100),
    ToggleOff = Color3.fromRGB(60, 60, 60),
}

-- Safe Configuration
local CONFIG = {
    BEHIND_DISTANCE = 10,
    HEIGHT_OFFSET = 2,
    ATTACK_DELAY = 1.0,
    M2_ATTACK_DELAY = 1.5,
    ATTACK_COOLDOWN = 0.8,
    MAX_SEARCH_DISTANCE = math.huge,  -- Search anywhere
    TELEPORT_DISTANCE = 50,           -- Teleport if enemy > 50 studs away
    MAX_HEIGHT_DIFFERENCE = math.huge,
    MIN_HEIGHT = -500,                -- Allow underground
    MAX_HEIGHT = 10000,               -- Allow sky enemies
    CACHE_REFRESH = 0.5,              -- Check for new enemies every 0.5s
    SAFE_MODE_HEALTH = 30,
    ANTI_AFK_INTERVAL = 600,
    DEBUG_MODE = true,                -- Enable debug prints
}

-- Enemy List
local ENEMIES = {
    "Alien", "Android 19", "Android 20", "Android Prototype A", "Android Prototype B",
    "Android Prototype S", "Bandit", "Bear", "Big Snake", "Black Scorpion",
    "Brute", "Cell Jr", "Chi Expert", "Corrupt Officer", "Dino",
    "Egoist Goalie", "Egoist Striker", "Evil Crane Student", "Evil Majin", "Evil Namek",
    "Evil Saiyan", "Female Bandit", "Frog", "Galactic Patrol", "Giant Boar",
    "Giras", "Goku", "Gorilla", "Kick Boxer", "Kung Fu Master",
    "Mad Scientist", "Monster Carrot", "Pirate Cannoneer", "Pirate Elite", "Pirate Robot",
    "Pirate Scrub", "Pterodactyl", "Purple Fighter", "Rabbit Mobster", "Rabbit Rocketeer",
    "Red Ribbon Gunner", "Red Ribbon Soldier", "Saibablue", "Saibaman", "Saibared",
    "Sataru Dojo", "Scorpion", "Shielded Tank", "Snake", "Spopovich",
    "Tank", "Thug", "Universal Champion", "Wendigo", "Yamu", "Yeti"
}

-- State Management
local STATE = {
    farmActive = false,
    selectedEnemy = nil,
    currentTarget = nil,
    useM1 = true,
    useM2 = false,
    lastAttackTime = 0,
    lastM2Time = 0,
    guiVisible = true,
    characterDistance = 10,
    characterHeight = 0,
    enemiesFound = 0,
    currentDistance = 0,
}

-- GUI Elements Storage
local GUI_ELEMENTS = {}
local farmConnection = nil

-- Enemy Cache System
local cache = {
    enemiesFolder = nil,
    enemyCache = {},
    lastCacheUpdate = 0,
}

-- Helper Functions
local function debugPrint(message)
    if CONFIG.DEBUG_MODE then
        print("[JomHub Debug] " .. message)
    end
end

local function addGlow(obj, color, thickness)
    local stroke = Instance.new("UIStroke")
    stroke.Color = color
    stroke.Thickness = thickness or 2
    stroke.Transparency = 0.5
    stroke.Parent = obj
    return stroke
end

local function applySectionStyle(frame)
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, THEME.GradientStart),
        ColorSequenceKeypoint.new(1, THEME.GradientEnd)
    })
    gradient.Parent = frame
    addGlow(frame, THEME.Accent, 1).Transparency = 0.8
end

-- Enemy Detection Functions
local function getModelCFrame(model)
    if not model or not model.Parent then return nil end

    -- Try PrimaryPart first
    if model.PrimaryPart and model.PrimaryPart:IsA("BasePart") then
        return model.PrimaryPart.CFrame
    end

    -- Try common humanoid parts
    local hrp = model:FindFirstChild("HumanoidRootPart") or 
                model:FindFirstChild("Torso") or 
                model:FindFirstChild("UpperTorso") or
                model:FindFirstChild("Head")
    
    if hrp and hrp:IsA("BasePart") then
        return hrp.CFrame
    end

    -- Fallback: find any BasePart
    for _, part in ipairs(model:GetDescendants()) do
        if part:IsA("BasePart") then
            return part.CFrame
        end
    end

    return nil
end

local function isEnemyAlive(enemy)
    if not enemy or not enemy.Parent then return false end
    
    local humanoid = enemy:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    
    return humanoid.Health > 0.2 and humanoid:GetState() ~= Enum.HumanoidStateType.Dead
end

local function isValidEnemyPosition(enemyPos)
    if not enemyPos then return false end
    
    -- Very lenient height check
    if enemyPos.Y < CONFIG.MIN_HEIGHT or enemyPos.Y > CONFIG.MAX_HEIGHT then
        debugPrint("Enemy at invalid height: " .. tostring(enemyPos.Y))
        return false
    end
    
    return true
end

-- IMPROVED: Build enemy cache with better detection
local function buildEnemyCache()
    local currentTime = tick()
    
    -- Refresh cache based on config
    if cache.lastCacheUpdate and currentTime - cache.lastCacheUpdate < CONFIG.CACHE_REFRESH then
        return cache.enemyCache
    end

    cache.lastCacheUpdate = currentTime
    cache.enemyCache = {}

    local targetName = STATE.selectedEnemy
    if not targetName or targetName == "" then 
        debugPrint("No enemy selected")
        return cache.enemyCache 
    end

    local targetLower = string.lower(targetName)
    debugPrint("Searching for: " .. targetName)

    -- Search ALL workspace descendants for enemies
    local searchCount = 0
    local foundCount = 0
    
    for _, desc in ipairs(workspace:GetDescendants()) do
        if desc:IsA("Model") and desc.Name then
            searchCount = searchCount + 1
            
            -- Case-insensitive name match
            if string.lower(desc.Name) == targetLower then
                local hum = desc:FindFirstChildOfClass("Humanoid")
                
                if hum and hum.Health and hum.Health > 0.2 then
                    local cf = getModelCFrame(desc)
                    
                    if cf and isValidEnemyPosition(cf.Position) then
                        foundCount = foundCount + 1
                        table.insert(cache.enemyCache, {
                            model = desc,
                            position = cf.Position,
                            humanoid = hum,
                            distance = 0  -- Will calculate later
                        })
                    end
                end
            end
        end
    end

    debugPrint("Searched " .. searchCount .. " models, found " .. foundCount .. " " .. targetName)
    STATE.enemiesFound = foundCount

    return cache.enemyCache
end

-- IMPROVED: Find closest OR lowest health enemy
local function findBestEnemy()
    local char = player.Character
    if not char then return nil end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local playerPos = hrp.Position
    
    -- Build fresh cache
    buildEnemyCache()
    
    if #cache.enemyCache == 0 then 
        debugPrint("No enemies in cache")
        return nil 
    end
    
    local bestEnemy = nil
    local lowestHealth = math.huge
    local closestDistance = math.huge
    
    -- Calculate distances and find best target
    for _, entry in ipairs(cache.enemyCache) do
        if entry.model and entry.model.Parent and isEnemyAlive(entry.model) then
            local distance = (playerPos - entry.position).Magnitude
            entry.distance = distance
            
            -- Prioritize by health (lowest health = priority target)
            if entry.humanoid.Health < lowestHealth then
                lowestHealth = entry.humanoid.Health
                bestEnemy = entry.model
                closestDistance = distance
            elseif entry.humanoid.Health == lowestHealth and distance < closestDistance then
                -- If same health, pick closest
                bestEnemy = entry.model
                closestDistance = distance
            end
        end
    end
    
    if bestEnemy then
        STATE.currentDistance = closestDistance
        debugPrint("Selected: " .. bestEnemy.Name .. " | HP: " .. math.floor(lowestHealth) .. " | Distance: " .. math.floor(closestDistance))
    end
    
    return bestEnemy
end

local function attackEnemy(character)
    if not STATE.currentTarget or not isEnemyAlive(STATE.currentTarget) then 
        return 
    end
    
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return end
    local inputEvent = backpack:FindFirstChild("Input")
    if not inputEvent then return end
    
    local currentTime = tick()
    if currentTime - STATE.lastAttackTime < CONFIG.ATTACK_COOLDOWN then return end
    
    local velocity = hrp.AssemblyLinearVelocity or hrp.Velocity or Vector3.new(0,0,0)
    local attackData = {
        running = velocity.Magnitude > 16,
        inair = hrp.Position.Y > 5
    }
    
    pcall(function()
        if STATE.useM1 then
            inputEvent:FireServer("m1", attackData)
            STATE.lastAttackTime = currentTime
        end
        
        if STATE.useM2 and currentTime - STATE.lastM2Time >= CONFIG.M2_ATTACK_DELAY then
            inputEvent:FireServer("m2", attackData)
            STATE.lastM2Time = currentTime
        end
    end)
end

-- FIXED: Direct teleport system (no tweening)
local function moveToBehind(hrp, targetCF, distance)
    if not hrp or not targetCF then return end

    -- Calculate position behind enemy
    local behindPos = targetCF.Position - (targetCF.LookVector * STATE.characterDistance)
    behindPos = behindPos + Vector3.new(0, STATE.characterHeight, 0)
    
    -- Create CFrame facing enemy
    local newCFrame = CFrame.new(behindPos, targetCF.Position)
    
    -- DIRECT TELEPORT (instant, works for any distance)
    hrp.CFrame = newCFrame
    
    -- Stop all momentum
    hrp.Velocity = Vector3.new(0, 0, 0)
    pcall(function() 
        hrp.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
        hrp.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
    end)
end

local function checkHealth()
    local character = player.Character
    if not character then return false end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    
    return (humanoid.Health / humanoid.MaxHealth) * 100 > CONFIG.SAFE_MODE_HEALTH
end

-- IMPROVED: Main farming loop with better targeting
local function startFarming()
    STATE.farmActive = true
    
    if farmConnection then
        farmConnection:Disconnect()
    end
    
    debugPrint("Auto farm started for: " .. tostring(STATE.selectedEnemy))
    
    farmConnection = RunService.Heartbeat:Connect(function()
        if not STATE.farmActive then
            if farmConnection then
                farmConnection:Disconnect()
                farmConnection = nil
            end
            return
        end
        
        pcall(function()
            local character = player.Character
            if not character then return end
            
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if not hrp then return end
            
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if not humanoid then return end
            
            -- Check if current target is dead
            if STATE.currentTarget and not isEnemyAlive(STATE.currentTarget) then
                debugPrint("Target died, finding new target")
                STATE.currentTarget = nil
            end
            
            -- Find new target if needed
            if not STATE.currentTarget then
                STATE.currentTarget = findBestEnemy()
            end
            
            -- Update status if no target
            if not STATE.currentTarget then
                if GUI_ELEMENTS.statusLabel then
                    GUI_ELEMENTS.statusLabel.Text = "Status: Searching for " .. (STATE.selectedEnemy or "enemies") .. "..."
                    GUI_ELEMENTS.statusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
                end
                return
            end
            
            -- Double-check target is alive
            if not isEnemyAlive(STATE.currentTarget) then
                STATE.currentTarget = nil
                return
            end
            
            -- Get target position
            local targetCF = getModelCFrame(STATE.currentTarget)
            if not targetCF then 
                debugPrint("Could not get target CFrame")
                STATE.currentTarget = nil
                return 
            end
            
            -- Calculate distance
            local distance = (hrp.Position - targetCF.Position).Magnitude
            
            -- TELEPORT to enemy (works for any distance)
            moveToBehind(hrp, targetCF, distance)
            
            -- Disable auto-rotate
            humanoid.AutoRotate = false
            
            -- Attack enemy
            attackEnemy(character)
            
            -- Update status
            if GUI_ELEMENTS.statusLabel then
                GUI_ELEMENTS.statusLabel.Text = string.format(
                    "Status: Farming %s | Distance: %d | Enemies: %d",
                    STATE.selectedEnemy,
                    math.floor(distance),
                    STATE.enemiesFound
                )
                GUI_ELEMENTS.statusLabel.TextColor3 = THEME.Green
            end
        end)
    end)
end

local function stopFarming()
    STATE.farmActive = false
    STATE.currentTarget = nil
    
    debugPrint("Auto farm stopped")
    
    if farmConnection then
        farmConnection:Disconnect()
        farmConnection = nil
    end
    
    pcall(function()
        local character = player.Character
        if character then
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid then humanoid.AutoRotate = true end
        end
    end)
    
    if GUI_ELEMENTS.statusLabel then
        GUI_ELEMENTS.statusLabel.Text = "Status: Idle"
        GUI_ELEMENTS.statusLabel.TextColor3 = THEME.TextDim
    end
    if GUI_ELEMENTS.startButton then
        GUI_ELEMENTS.startButton.Text = "START"
        GUI_ELEMENTS.startButton.BackgroundColor3 = Color3.fromRGB(51, 204, 51)
    end
end

local function createUI()
    local PlayerGui = player:FindFirstChildOfClass("PlayerGui")
    if not PlayerGui then return end
    
    local existing = PlayerGui:FindFirstChild("JomHubSafe")
    if existing then existing:Destroy() end
    
    local gui = Instance.new("ScreenGui")
    gui.Name = "JomHubSafe"
    gui.ResetOnSpawn = false
    gui.Parent = PlayerGui
    
    local main = Instance.new("Frame")
    main.Size = UDim2.new(0, 900, 0, 650)
    main.Position = UDim2.new(0.5, -450, 0.5, -325)
    main.BackgroundColor3 = THEME.Background
    main.BorderSizePixel = 0
    main.ClipsDescendants = true
    main.Parent = gui
    
    local bgGradient = Instance.new("UIGradient")
    bgGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, THEME.GradientStart),
        ColorSequenceKeypoint.new(1, THEME.GradientEnd)
    })
    bgGradient.Parent = main
    
    addGlow(main, THEME.Accent, 2).Transparency = 0.3
    
    local navBar = Instance.new("Frame")
    navBar.Size = UDim2.new(1, 0, 0, 50)
    navBar.BackgroundColor3 = THEME.BackgroundDark
    navBar.BorderSizePixel = 0
    navBar.Parent = main
    
    local navLayout = Instance.new("UIListLayout")
    navLayout.FillDirection = Enum.FillDirection.Horizontal
    navLayout.Padding = UDim.new(0, 15)
    navLayout.Parent = navBar
    
    local sidebar = Instance.new("Frame")
    sidebar.Size = UDim2.new(0, 200, 1, -50)
    sidebar.Position = UDim2.new(0, -60, 0, 50)
    sidebar.BackgroundColor3 = THEME.Sidebar
    sidebar.BorderSizePixel = 0
    sidebar.Parent = main
    
    local logo = Instance.new("TextLabel")
    logo.Size = UDim2.new(1, -20, 0, 50)
    logo.Position = UDim2.new(0, 75, 0, 15)
    logo.BackgroundTransparency = 1
    logo.Text = "HOME"
    logo.Font = Enum.Font.SourceSansBold
    logo.TextSize = 20
    logo.TextColor3 = THEME.Text
    logo.TextXAlignment = Enum.TextXAlignment.Left
    logo.Parent = sidebar
    
    local autoTabContainer = Instance.new("Frame")
    autoTabContainer.Size = UDim2.new(1, 0, 0, 48)
    autoTabContainer.Position = UDim2.new(0, 0, 0, 65)
    autoTabContainer.BackgroundTransparency = 1
    autoTabContainer.Visible = false
    autoTabContainer.Parent = sidebar
    
    local content = Instance.new("Frame")
    content.Size = UDim2.new(1, -215, 1, -65)
    content.Position = UDim2.new(0, 180, 0, 65)
    content.BackgroundTransparency = 1
    content.Parent = main
    
    local contents = {}
    
    local navItems = {"HOME", "QUESTS", "AUTO", "CHARACTER", "TELEPORT", "SETTINGS", "HELP"}
    local navLinks = {}
    
    for _, name in ipairs(navItems) do
        local navLink = Instance.new("TextButton")
        navLink.Size = UDim2.new(0, string.len(name) * 10 + 20, 1, 0)
        navLink.BackgroundTransparency = 1
        navLink.Text = name
        navLink.Font = Enum.Font.SourceSans
        navLink.TextSize = 14
        navLink.TextColor3 = name == "HOME" and THEME.Text or THEME.TextDim
        navLink.Parent = navBar
        navLinks[name] = navLink
        
        navLink.MouseButton1Click:Connect(function()
            for navName, link in pairs(navLinks) do
                link.TextColor3 = navName == name and THEME.Text or THEME.TextDim
            end
            
            logo.Text = name
            
            for contentName, contentFrame in pairs(contents) do
                contentFrame.Visible = contentName == name
            end
            
            if name == "AUTO" then
                autoTabContainer.Visible = true
            else
                autoTabContainer.Visible = false
            end
        end)
    end
    
    local autoFarmTab = Instance.new("TextButton")
    autoFarmTab.Size = UDim2.new(1, 0, 0, 40)
    autoFarmTab.BackgroundColor3 = Color3.fromRGB(26, 26, 46)
    autoFarmTab.BorderSizePixel = 0
    autoFarmTab.Text = "AUTO FARM"
    autoFarmTab.Font = Enum.Font.SourceSansBold
    autoFarmTab.TextSize = 14
    autoFarmTab.TextColor3 = Color3.fromRGB(220, 230, 255)
    autoFarmTab.Parent = autoTabContainer
    
    local homeContent = Instance.new("ScrollingFrame")
    homeContent.Name = "HomeContent"
    homeContent.Size = UDim2.new(1, 0, 1, 0)
    homeContent.BackgroundTransparency = 1
    homeContent.BorderSizePixel = 0
    homeContent.ScrollBarThickness = 6
    homeContent.CanvasSize = UDim2.new(0, 0, 0, 400)
    homeContent.Visible = true
    homeContent.Parent = content
    contents["HOME"] = homeContent
    
    for _, name in ipairs({"QUESTS", "CHARACTER", "TELEPORT", "SETTINGS", "HELP"}) do
        local placeholder = Instance.new("Frame")
        placeholder.Size = UDim2.new(1, 0, 1, 0)
        placeholder.BackgroundTransparency = 1
        placeholder.Visible = false
        placeholder.Parent = content
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 0, 50)
        label.Position = UDim2.new(0, 0, 0.5, -25)
        label.BackgroundTransparency = 1
        label.Text = name .. " - Coming Soon"
        label.Font = Enum.Font.SourceSans
        label.TextSize = 20
        label.TextColor3 = THEME.TextDim
        label.Parent = placeholder
        
        contents[name] = placeholder
    end
    
    local homeIntro = Instance.new("Frame")
    homeIntro.Size = UDim2.new(1, 0, 0, 300)
    homeIntro.Position = UDim2.new(0, 0, 0, 20)
    homeIntro.BackgroundColor3 = THEME.SectionBg
    homeIntro.BorderSizePixel = 0
    homeIntro.Parent = homeContent
    applySectionStyle(homeIntro)
    
    local introTitle = Instance.new("TextLabel")
    introTitle.Size = UDim2.new(1, -40, 0, 60)
    introTitle.Position = UDim2.new(0, 20, 0, 30)
    introTitle.BackgroundTransparency = 1
    introTitle.Text = "JOMHUB SAFE VERSION"
    introTitle.Font = Enum.Font.SourceSansBold
    introTitle.TextSize = 28
    introTitle.TextColor3 = THEME.Text
    introTitle.TextXAlignment = Enum.TextXAlignment.Center
    introTitle.Parent = homeIntro
    
    local introDesc = Instance.new("TextLabel")
    introDesc.Size = UDim2.new(1, -40, 0, 180)
    introDesc.Position = UDim2.new(0, 20, 0, 100)
    introDesc.BackgroundTransparency = 1
    introDesc.Text = "Safe auto-farming with UNLIMITED RANGE\n\nFeatures:\n• Detects enemies ANYWHERE in the map\n• Instant teleportation to far enemies\n• Smart targeting (lowest health priority)\n• Real-time distance tracking\n• Debug mode for troubleshooting\n\nPress 'P' to toggle GUI"
    introDesc.Font = Enum.Font.SourceSans
    introDesc.TextSize = 14
    introDesc.TextColor3 = THEME.TextDim
    introDesc.TextXAlignment = Enum.TextXAlignment.Left
    introDesc.TextYAlignment = Enum.TextYAlignment.Top
    introDesc.TextWrapped = true
    introDesc.Parent = homeIntro
    
    local autoFarmContent = Instance.new("ScrollingFrame")
    autoFarmContent.Name = "AutoContent"
    autoFarmContent.Size = UDim2.new(1, 0, 1, 0)
    autoFarmContent.BackgroundTransparency = 1
    autoFarmContent.BorderSizePixel = 0
    autoFarmContent.ScrollBarThickness = 6
    autoFarmContent.CanvasSize = UDim2.new(0, 0, 0, 800)
    autoFarmContent.Visible = false
    autoFarmContent.Parent = content
    contents["AUTO"] = autoFarmContent
    
    local enemySection = Instance.new("Frame")
    enemySection.Size = UDim2.new(1, 0, 0, 500)
    enemySection.BackgroundColor3 = THEME.SectionBg
    enemySection.BorderSizePixel = 0
    enemySection.Parent = autoFarmContent
    applySectionStyle(enemySection)
    
    local enemyTitle = Instance.new("TextLabel")
    enemyTitle.Size = UDim2.new(1, -20, 0, 30)
    enemyTitle.Position = UDim2.new(0, 10, 0, 5)
    enemyTitle.BackgroundTransparency = 1
    enemyTitle.Text = "Enemy Selection (Unlimited Range)"
    enemyTitle.Font = Enum.Font.SourceSansBold
    enemyTitle.TextSize = 14
    enemyTitle.TextColor3 = THEME.Text
    enemyTitle.TextXAlignment = Enum.TextXAlignment.Left
    enemyTitle.Parent = enemySection
    
    local enemyListContainer = Instance.new("Frame")
    enemyListContainer.Size = UDim2.new(1, -20, 0, 400)
    enemyListContainer.Position = UDim2.new(0, 10, 0, 45)
    enemyListContainer.BackgroundColor3 = Color3.fromRGB(26, 26, 46)
    enemyListContainer.BorderSizePixel = 0
    enemyListContainer.Parent = enemySection
    addGlow(enemyListContainer, THEME.Accent, 2).Transparency = 0.3
    
    local enemyScroll = Instance.new("ScrollingFrame")
    enemyScroll.Size = UDim2.new(1, 0, 1, 0)
    enemyScroll.BackgroundTransparency = 1
    enemyScroll.BorderSizePixel = 0
    enemyScroll.ScrollBarThickness = 6
    enemyScroll.Parent = enemyListContainer
    
    local enemyListLayout = Instance.new("UIListLayout")
    enemyListLayout.Padding = UDim.new(0, 2)
    enemyListLayout.Parent = enemyScroll
    
    for _, enemyName in ipairs(ENEMIES) do
        local enemyRow = Instance.new("Frame")
        enemyRow.Size = UDim2.new(1, -10, 0, 35)
        enemyRow.BackgroundColor3 = Color3.fromRGB(40, 40, 64)
        enemyRow.BorderSizePixel = 0
        enemyRow.Parent = enemyScroll
        
        local checkbox = Instance.new("Frame")
        checkbox.Size = UDim2.new(0, 16, 0, 16)
        checkbox.Position = UDim2.new(0, 10, 0.5, -8)
        checkbox.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
        checkbox.BorderSizePixel = 1
        checkbox.BorderColor3 = Color3.fromRGB(100, 100, 100)
        checkbox.Name = "Checkbox"
        checkbox.Parent = enemyRow
        
        local enemyLabel = Instance.new("TextLabel")
        enemyLabel.Size = UDim2.new(1, -40, 1, 0)
        enemyLabel.Position = UDim2.new(0, 35, 0, 0)
        enemyLabel.BackgroundTransparency = 1
        enemyLabel.Text = enemyName
        enemyLabel.Font = Enum.Font.SourceSans
        enemyLabel.TextSize = 13
        enemyLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
        enemyLabel.TextXAlignment = Enum.TextXAlignment.Left
        enemyLabel.Parent = enemyRow
        
        local rowButton = Instance.new("TextButton")
        rowButton.Size = UDim2.new(1, 0, 1, 0)
        rowButton.BackgroundTransparency = 1
        rowButton.Text = ""
        rowButton.Parent = enemyRow
        
        rowButton.MouseButton1Click:Connect(function()
            STATE.selectedEnemy = enemyName
            debugPrint("Selected enemy: " .. enemyName)
            
            for _, child in ipairs(enemyScroll:GetChildren()) do
                if child:IsA("Frame") then
                    local cb = child:FindFirstChild("Checkbox")
                    if cb then
                        local label = child:FindFirstChild("TextLabel")
                        if label and label.Text == enemyName then
                            cb.BackgroundColor3 = THEME.Green
                        else
                            cb.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
                        end
                    end
                end
            end
        end)
    end
    
    enemyScroll.CanvasSize = UDim2.new(0, 0, 0, enemyListLayout.AbsoluteContentSize.Y + 4)
    
    local attackFrame = Instance.new("Frame")
    attackFrame.Size = UDim2.new(1, -20, 0, 40)
    attackFrame.Position = UDim2.new(0, 10, 0, 455)
    attackFrame.BackgroundTransparency = 1
    attackFrame.Parent = enemySection
    
    local m1Toggle = Instance.new("TextButton")
    m1Toggle.Size = UDim2.new(0, 100, 0, 30)
    m1Toggle.Position = UDim2.new(0, 0, 0, 0)
    m1Toggle.BackgroundColor3 = STATE.useM1 and THEME.ToggleOn or THEME.ToggleOff
    m1Toggle.Text = "M1: " .. (STATE.useM1 and "ON" or "OFF")
    m1Toggle.Font = Enum.Font.SourceSans
    m1Toggle.TextSize = 14
    m1Toggle.TextColor3 = THEME.Text
    m1Toggle.Parent = attackFrame
    
    m1Toggle.MouseButton1Click:Connect(function()
        STATE.useM1 = not STATE.useM1
        m1Toggle.BackgroundColor3 = STATE.useM1 and THEME.ToggleOn or THEME.ToggleOff
        m1Toggle.Text = "M1: " .. (STATE.useM1 and "ON" or "OFF")
    end)
    
    local m2Toggle = Instance.new("TextButton")
    m2Toggle.Size = UDim2.new(0, 100, 0, 30)
    m2Toggle.Position = UDim2.new(0, 110, 0, 0)
    m2Toggle.BackgroundColor3 = STATE.useM2 and THEME.ToggleOn or THEME.ToggleOff
    m2Toggle.Text = "M2: " .. (STATE.useM2 and "ON" or "OFF")
    m2Toggle.Font = Enum.Font.SourceSans
    m2Toggle.TextSize = 14
    m2Toggle.TextColor3 = THEME.Text
    m2Toggle.Parent = attackFrame
    
    m2Toggle.MouseButton1Click:Connect(function()
        STATE.useM2 = not STATE.useM2
        m2Toggle.BackgroundColor3 = STATE.useM2 and THEME.ToggleOn or THEME.ToggleOff
        m2Toggle.Text = "M2: " .. (STATE.useM2 and "ON" or "OFF")
    end)
    
    local advancedSection = Instance.new("Frame")
    advancedSection.Size = UDim2.new(1, 0, 0, 150)
    advancedSection.Position = UDim2.new(0, 0, 0, 520)
    advancedSection.BackgroundColor3 = THEME.SectionBg
    advancedSection.BorderSizePixel = 0
    advancedSection.Parent = autoFarmContent
    applySectionStyle(advancedSection)
    
    local advTitle = Instance.new("TextLabel")
    advTitle.Size = UDim2.new(1, -20, 0, 30)
    advTitle.Position = UDim2.new(0, 10, 0, 5)
    advTitle.BackgroundTransparency = 1
    advTitle.Text = "Advanced Settings"
    advTitle.Font = Enum.Font.SourceSansBold
    advTitle.TextSize = 14
    advTitle.TextColor3 = THEME.Text
    advTitle.TextXAlignment = Enum.TextXAlignment.Left
    advTitle.Parent = advancedSection
    
    local distLabel = Instance.new("TextLabel")
    distLabel.Size = UDim2.new(0, 200, 0, 20)
    distLabel.Position = UDim2.new(0, 10, 0, 45)
    distLabel.BackgroundTransparency = 1
    distLabel.Text = "Distance: " .. STATE.characterDistance
    distLabel.Font = Enum.Font.SourceSans
    distLabel.TextSize = 14
    distLabel.TextColor3 = THEME.TextDim
    distLabel.TextXAlignment = Enum.TextXAlignment.Left
    distLabel.Parent = advancedSection
    
    local distSlider = Instance.new("TextButton")
    distSlider.Size = UDim2.new(0, 200, 0, 20)
    distSlider.Position = UDim2.new(0, 10, 0, 70)
    distSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    distSlider.Text = ""
    distSlider.Parent = advancedSection
    
    local distFill = Instance.new("Frame")
    distFill.Size = UDim2.new(0.2, 0, 1, 0)
    distFill.BackgroundColor3 = THEME.Accent
    distFill.BorderSizePixel = 0
    distFill.Parent = distSlider
    
    local heightLabel = Instance.new("TextLabel")
    heightLabel.Size = UDim2.new(0, 200, 0, 20)
    heightLabel.Position = UDim2.new(0, 220, 0, 45)
    heightLabel.BackgroundTransparency = 1
    heightLabel.Text = "Height: " .. STATE.characterHeight
    heightLabel.Font = Enum.Font.SourceSans
    heightLabel.TextSize = 14
    heightLabel.TextColor3 = THEME.TextDim
    heightLabel.TextXAlignment = Enum.TextXAlignment.Left
    heightLabel.Parent = advancedSection
    
    local heightSlider = Instance.new("TextButton")
    heightSlider.Size = UDim2.new(0, 200, 0, 20)
    heightSlider.Position = UDim2.new(0, 220, 0, 70)
    heightSlider.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    heightSlider.Text = ""
    heightSlider.Parent = advancedSection
    
    local heightFill = Instance.new("Frame")
    heightFill.Size = UDim2.new(0.25, 0, 1, 0)
    heightFill.BackgroundColor3 = THEME.Accent
    heightFill.BorderSizePixel = 0
    heightFill.Parent = heightSlider
    
    local distDragging = false
    distSlider.MouseButton1Down:Connect(function()
        distDragging = true
        local mouse = player:GetMouse()
        
        local function updateDist()
            if not distDragging then return end
            local relX = math.clamp((mouse.X - distSlider.AbsolutePosition.X) / distSlider.AbsoluteSize.X, 0, 1)
            local newDistance = math.floor(5 + (relX * 25))
            STATE.characterDistance = newDistance
            distFill.Size = UDim2.new(relX, 0, 1, 0)
            distLabel.Text = "Distance: " .. newDistance
        end
        
        local moveConnection = mouse.Move:Connect(updateDist)
        updateDist()
        
        local releaseConnection
        releaseConnection = UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                distDragging = false
                moveConnection:Disconnect()
                releaseConnection:Disconnect()
            end
        end)
    end)
    
    local heightDragging = false
    heightSlider.MouseButton1Down:Connect(function()
        heightDragging = true
        local mouse = player:GetMouse()
        
        local function updateHeight()
            if not heightDragging then return end
            local relX = math.clamp((mouse.X - heightSlider.AbsolutePosition.X) / heightSlider.AbsoluteSize.X, 0, 1)
            local newHeight = math.floor(-5 + (relX * 20))
            STATE.characterHeight = newHeight
            heightFill.Size = UDim2.new(relX, 0, 1, 0)
            heightLabel.Text = "Height: " .. newHeight
        end
        
        local moveConnection = mouse.Move:Connect(updateHeight)
        updateHeight()
        
        local releaseConnection
        releaseConnection = UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                heightDragging = false
                moveConnection:Disconnect()
                releaseConnection:Disconnect()
            end
        end)
    end)
    
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, -20, 0, 30)
    statusLabel.Position = UDim2.new(0, 10, 0, 110)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "Status: Idle"
    statusLabel.Font = Enum.Font.SourceSans
    statusLabel.TextSize = 14
    statusLabel.TextColor3 = THEME.TextDim
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.Parent = advancedSection
    GUI_ELEMENTS.statusLabel = statusLabel
    
    local startButton = Instance.new("TextButton")
    startButton.Size = UDim2.new(0, 200, 0, 45)
    startButton.Position = UDim2.new(0.5, -100, 0, 680)
    startButton.BackgroundColor3 = Color3.fromRGB(51, 204, 51)
    startButton.BorderSizePixel = 0
    startButton.Text = "START"
    startButton.Font = Enum.Font.SourceSansBold
    startButton.TextSize = 18
    startButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    startButton.Parent = autoFarmContent
    GUI_ELEMENTS.startButton = startButton
    
    startButton.MouseButton1Click:Connect(function()
        if not STATE.selectedEnemy then
            statusLabel.Text = "Status: Please select an enemy first!"
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            return
        end
        
        if STATE.farmActive then
            stopFarming()
        else
            startButton.Text = "STOP"
            startButton.BackgroundColor3 = Color3.fromRGB(204, 51, 51)
            startFarming()
        end
    end)
    
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Enum.KeyCode.P then
            STATE.guiVisible = not STATE.guiVisible
            gui.Enabled = STATE.guiVisible
        end
    end)
    
    task.spawn(function()
        while true do
            wait(CONFIG.ANTI_AFK_INTERVAL)
            local vu = game:GetService("VirtualUser")
            if vu then
                vu:CaptureController()
                vu:ClickButton2(Vector2.new())
            end
        end
    end)
end

createUI()
print("╔═══════════════════════════════════════════════════════╗")
print("║      JOMHUB SAFE VERSION - UNLIMITED RANGE LOADED     ║")
print("║                                                       ║")
print("║  • Detects enemies ANYWHERE in workspace             ║")
print("║  • Instant teleportation (no distance limits)        ║")
print("║  • Smart targeting (lowest HP priority)              ║")
print("║  • Press 'P' to toggle GUI                           ║")
print("║  • Check F9 console for debug info                   ║")
print("╚═══════════════════════════════════════════════════════╝")
